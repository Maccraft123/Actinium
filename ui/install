#!/bin/false
# this is meant to run on a liveusb
set -v

. ~/info

CHOSEN=no

MESACHOSEN=no

until [ "$CHOSEN" != "no" ]; do
	echo "Which UI do you want installed?"
	echo -n "Choose one of: phosh, sway or none for no ui"
	read -p '? ' CHOSEN
done

until [ "$MESACHOSEN" != "no" ]; do
	echo "Would you like proprietary Mesa Drivers? Mesa currently works better than Panfrost Open Source but again, is proprietary."
	echo -n "Choose: mesa, panfrost"
	read -p '? ' MESACHOSEN
done

if [ "$MESACHOSEN" != "panfrost" ]; then
	if [ $INST_EMMC = 1 ]; then
		chroot /mnt sudo apt update
		chroot /mnt sudo apt install software-properties-common
		chroot /mnt sudo add-apt-repository 'deb-src https://deb.debian.org/debian sid main'
		chroot /mnt sudo apt-get install git
		chroot /mnt sudo apt build-dep mesa
		chroot /mnt git clone https://github.com/Maccraft123/armhf-tools
		chroot /mnt ./armhf-tools/build-mesa
		chroot /mnt sudo ./armhf-tools/install-mesa
	else
		sudo apt update
		sudo apt install software-properties-common
		sudo add-apt-repository 'deb-src https://deb.debian.org/debian sid main'
		sudo apt-get install git
		sudo apt build-dep mesa
		git clone https://github.com/Maccraft123/armhf-tools
		./armhf-tools/build-mesa
		sudo ./armhf-tools/install-mesa
	
	fi

fi
		
		

if [ "$CHOSEN" != "none" ]; then
	source ~/ui/$CHOSEN/include
	# xorg doesn't run on mt8183, TODO: why?
	if [ "$BASEBOARD" = "kukui" -a "$DISPSERVER" = "xorg" ]; then
		echo "Xorg isn't supported on $BASEBOARD/$TARGET"
		exit 1
	fi
	case $ROOTFS in
		debian)
			export INSTALLER='apt install -y'
			export PKGS="$DEBS"
			;;
		void*)
			export INSTALLER='xbps-install -y'
			export PKGS="$XBPS"
			;;
	esac
	# magic line that installs all the packages
	$CHRT $INSTALLER $PKGS
	case $CHOSEN in
		sway)
			if [ $INST_EMMC = 1 ]; then
                                echo "Copying sway config"
                                mkdir -p /mnt/etc/sway
                                cp ~/swayconfig /mnt/etc/sway/config
                                echo 'tty | grep tty1 && exec sway' >> /mnt/home/$USERNAME/.bashrc
                                # TODO: $RUN_COMMAND setting in ui information
                        else
                                mv ~/swayconfig /etc/sway/config
                                echo 'tty | grep tty1 && exec sway' >> /home/$USERNAME/.bashrc
                        fi
			;;
		phosh)
			echo "Phosh NEEDS password that is only digits"
			$CHRT passwd $USERNAME
			$CHRT systemctl enable phosh
			;;
	esac
	echo "Installing common system utilities"
	$CHRT $INSTALLER firefox pulseaudio pavucontrol htop ssh
fi

echo "Done installing UI!"
